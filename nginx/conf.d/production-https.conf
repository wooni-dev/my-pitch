# Frontend server (Next.js) - HTTP to HTTPS 리다이렉트
server {
    listen 80;
    listen [::]:80;
    server_name my-pitch.work;

    # Let's Encrypt 챌린지용
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 나머지 모든 요청은 HTTPS로 리다이렉트
    location / {
        return 301 https://$host$request_uri;
    }
}

# Frontend server (Next.js) - HTTPS
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name my-pitch.work;

    # SSL 인증서 설정
    ssl_certificate /etc/letsencrypt/live/my-pitch.work/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/my-pitch.work/privkey.pem;
    
    # SSL 보안 설정
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Next.js 프로덕션 서버로 프록시
    location / {
        proxy_pass http://client:3000;
        
        # 헤더 설정
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 타임아웃 설정
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

# API Server (Flask 백엔드) - HTTP to HTTPS 리다이렉트
server {
    listen 80;
    listen [::]:80;
    server_name api.my-pitch.work;

    # Let's Encrypt 챌린지용
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 나머지 모든 요청은 HTTPS로 리다이렉트
    location / {
        return 301 https://$host$request_uri;
    }
}

# API Server (Flask 백엔드) - HTTPS
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.my-pitch.work;

    # SSL 인증서 설정
    ssl_certificate /etc/letsencrypt/live/api.my-pitch.work/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.my-pitch.work/privkey.pem;
    
    # SSL 보안 설정
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # 업로드 파일 크기 제한 (오디오 파일 업로드용)
    client_max_body_size 7M;
    
    # 파일 크기 초과 에러 핸들러
    error_page 413 @request_entity_too_large;

    location @request_entity_too_large {
        default_type application/json;
        add_header 'Access-Control-Allow-Origin' 'https://my-pitch.work' always;
        add_header 'Access-Control-Allow-Methods' 'POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type' always;
        return 413 '{"message": "파일 크기가 7MB를 초과했습니다. 더 작은 파일을 업로드해주세요."}';
    }

    # Flask API
    location / {
        proxy_pass http://api:5000/;
        
        # 헤더 설정
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 타임아웃 설정 (오디오 분석 작업을 위해 길게 - 10분)
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }
}

# File server (MinIO) - HTTP to HTTPS 리다이렉트
server {
    listen 80;
    listen [::]:80;
    server_name files.my-pitch.work;

    # Let's Encrypt 챌린지용
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 나머지 모든 요청은 HTTPS로 리다이렉트
    location / {
        return 301 https://$host$request_uri;
    }
}

# File server (MinIO) - HTTPS
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name files.my-pitch.work;

    # SSL 인증서 설정
    ssl_certificate /etc/letsencrypt/live/files.my-pitch.work/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/files.my-pitch.work/privkey.pem;
    
    # SSL 보안 설정
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
        # MinIO API로 프록시
        proxy_pass http://fileserver:9000;
        
        # 프록시 헤더 설정
        proxy_set_header Host fileserver:9000;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 타임아웃 설정 (10분 : 대용량 파일 다운로드용)
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }
}

