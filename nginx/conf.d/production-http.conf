# Frontend server (Next.js)
server {
    listen 80;
    listen [::]:80;
    server_name my-pitch.work;

    # Next.js 프론트엔드
    location / {
        # Next.js 프로덕션 서버로 프록시
        proxy_pass http://client:3000;
        
        # 헤더 설정
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 타임아웃 설정
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

# API Server (Flask 백엔드)
server {
    listen 80;
    listen [::]:80;
    server_name api.my-pitch.work;

    # 업로드 파일 크기 제한 (오디오 파일 업로드용)
    client_max_body_size 7M;
    
    # 파일 크기 초과 에러 핸들러
    error_page 413 @request_entity_too_large;

    location @request_entity_too_large {
        default_type application/json;
        add_header 'Access-Control-Allow-Origin' 'http://my-pitch.work' always;
        add_header 'Access-Control-Allow-Methods' 'POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type' always;
        return 413 '{"message": "파일 크기가 7MB를 초과했습니다. 더 작은 파일을 업로드해주세요."}';
    }

    # Flask API
    location / {
        proxy_pass http://api:5000/;
        
        # 헤더 설정
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 타임아웃 설정 (오디오 분석 작업을 위해 길게 - 10분)
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }
}

# File server (MinIO)
server {
    listen 80;
    listen [::]:80;
    server_name files.my-pitch.work;

    location / {
        # MinIO API로 프록시
        proxy_pass http://fileserver:9000;
        
        # 프록시 헤더 설정
        # MinIO Presigned URL 서명 검증을 위해 원본 Host 유지
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # MinIO가 외부 도메인으로 리다이렉트하지 않도록 설정
        proxy_set_header X-Forwarded-Host $http_host;
        
        # 타임아웃 설정 (10분 : 대용량 파일 다운로드용)
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        
        # 청크 인코딩 비활성화 (MinIO 호환성)
        proxy_buffering off;
        proxy_request_buffering off;
    }
}
