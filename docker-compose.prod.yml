services:
  nginx:
    ports:
      - "443:443"
    volumes:
      - ./nginx/conf.d/nginx.prod.conf:/etc/nginx/conf.d/default.conf
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot

  client:
    build:
      dockerfile: Dockerfile.prod
      args:
        # 빌드 시점에 환경변수 전달 (Next.js는 빌드 타임에 NEXT_PUBLIC_* 변수를 번들링)
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://api.my-pitch.work}
        NEXT_PUBLIC_MAX_FILE_SIZE_MB: ${MAX_FILE_SIZE_MB:-7}
    environment:
      - NODE_ENV=production

  api:
    build:
      dockerfile: Dockerfile.prod
    environment:
      - FLASK_ENV=production
      - TEMP_UPLOAD_FOLDER=${TEMP_UPLOAD_FOLDER:-/tmp/uploads}
      - TEMP_OUTPUT_FOLDER=${TEMP_OUTPUT_FOLDER:-/tmp/outputs}
    # GPU 설정 (VM에 GPU가 있는 경우에만 주석 해제)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all  # 모든 GPU 사용 (특정 개수 지정하려면 숫자로 변경, 예: 1)
              capabilities: [gpu]

  certbot:
    image: certbot/certbot
    container_name: my-pitch-certbot
    environment:
      - TZ=${TZ:-Asia/Seoul}
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
      - ./certbot/scripts/entrypoint.sh:/entrypoint.sh:ro
    entrypoint: ["/entrypoint.sh"]